<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GameZone Chat</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
.fade-in{animation:fadeIn 0.5s;} @keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
.pulse-glow{animation:pulseGlow 2s infinite;} @keyframes pulseGlow{0%,100%{box-shadow:0 0 5px #f97316;}50%{box-shadow:0 0 20px #f97316,0 0 30px #f97316;}}
</style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
<div class="container mx-auto px-4 py-8">
<div id="homeScreen" class="max-w-md mx-auto fade-in">
<div class="text-center mb-8">
<div class="w-24 h-24 bg-gradient-to-r from-orange-500 to-red-500 rounded-full mx-auto mb-6 flex items-center justify-center pulse-glow">
<i class="fas fa-gamepad text-3xl"></i></div>
<h1 class="text-4xl font-bold bg-gradient-to-r from-orange-500 to-red-500 bg-clip-text text-transparent">GameZone</h1>
<p class="text-gray-400 mt-2">Real-time Gaming Chat</p></div>

<div class="bg-gray-800 rounded-xl p-6 border border-gray-700 space-y-4">
<input type="text" id="usernameInput" placeholder="Enter your name" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-orange-500 transition-colors" value="Player">
<button id="createRoomBtn" class="w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 py-3 rounded-lg font-bold">Create Room</button>
<input type="text" id="roomIdInput" placeholder="Enter room code" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-orange-500 transition-colors">
<button id="joinRoomBtn" class="w-full bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 py-3 rounded-lg font-bold">Join Room</button>
</div>
</div>

<div id="chatScreen" class="hidden max-w-2xl mx-auto space-y-4">
<div class="bg-gray-800 rounded-xl border border-gray-700 p-4">
<div class="flex justify-between items-center">
<h2 class="text-xl font-bold">Room: <span id="roomIdDisplay">---</span></h2>
<p id="memberCount">1 gamer online</p>
<button id="leaveRoomBtn" class="bg-red-600 px-3 py-1 rounded">Leave</button>
</div>
<!-- Invite link section -->
<div class="flex items-center space-x-2 my-2">
    <input id="inviteLink" class="bg-gray-700 px-2 py-1 rounded w-full text-sm" readonly>
    <button id="copyInviteBtn" class="bg-blue-600 px-2 py-1 rounded text-sm">Copy Invite</button>
</div>
<div id="messagesContainer" class="h-96 overflow-y-auto mt-2 space-y-2 bg-gray-900/50 p-2 rounded">
<div class="text-center text-gray-500 py-12"><i class="fas fa-comments text-4xl mb-3"></i><p>Welcome!</p></div>
</div>
<input type="text" id="messageInput" placeholder="Type your message..." class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-orange-500">
<button id="sendMessageBtn" class="bg-orange-500 px-4 py-2 mt-2 rounded">Send</button>
</div>
</div>
</div>

<script>
const SERVER_URL = window.location.origin;
let currentRoom=null, username='Player', pollInterval=null;

// Emoji avatar list
const EMOJIS = ["🎮","🦊","🐼","🐯","🐸","🐵","🐧","🐻","🦄","🐲","🐱","🐶","🦁","🐰","🐹","🐭","🐤","🦉","🐙","🦕"];
let userEmoji = EMOJIS[Math.floor(Math.random()*EMOJIS.length)];
const emojiMap = {};

document.addEventListener('DOMContentLoaded',()=>{
setupEventListeners(); checkServerStatus();});

function setupEventListeners(){
document.getElementById('createRoomBtn').onclick=createRoom;
document.getElementById('joinRoomBtn').onclick=joinRoom;
document.getElementById('leaveRoomBtn').onclick=leaveRoom;
document.getElementById('sendMessageBtn').onclick=sendMessage;
document.getElementById('messageInput').addEventListener('keypress',e=>{if(e.key==='Enter')sendMessage();});
document.getElementById('copyInviteBtn').onclick=copyInviteLink;
}

async function checkServerStatus(){
try{await fetch(SERVER_URL+'/health');}catch(e){alert('Server offline');}}

async function createRoom(){
username=document.getElementById('usernameInput').value.trim()||'Player';
userEmoji = EMOJIS[Math.floor(Math.random()*EMOJIS.length)];
let res=await fetch(SERVER_URL+'/create_invite',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username})});
let data=await res.json(); 
if(data.success) {
    await joinRoomById(data.roomId);
}
}

async function joinRoom(){
let roomId=document.getElementById('roomIdInput').value.trim().toUpperCase();
if(!roomId)return alert('Enter room code'); 
userEmoji = EMOJIS[Math.floor(Math.random()*EMOJIS.length)];
await joinRoomById(roomId);}

async function joinRoomById(roomId){
username=document.getElementById('usernameInput').value.trim()||'Player';
let res=await fetch(`${SERVER_URL}/room/${roomId}/join`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username})});
let data=await res.json(); 
if(data.success){
    currentRoom=roomId; 
    showChatScreen(roomId); 
    updateMemberCount(data.member_count);
    setInviteLink(roomId);
    startPolling();
}else alert(data.error);}

function showChatScreen(roomId){
document.getElementById('homeScreen').classList.add('hidden'); 
document.getElementById('chatScreen').classList.remove('hidden'); 
document.getElementById('roomIdDisplay').textContent=roomId;
setInviteLink(roomId);
}

function setInviteLink(roomId){
    const link = `${window.location.origin}?room=${roomId}`;
    document.getElementById('inviteLink').value = link;
}

function copyInviteLink(){
    const input = document.getElementById('inviteLink');
    input.select();
    document.execCommand('copy');
    // Show copied feedback
    document.getElementById('copyInviteBtn').textContent = "Copied!";
    setTimeout(()=>{document.getElementById('copyInviteBtn').textContent = "Copy Invite";},1200);
}

function leaveRoom(){
currentRoom=null; 
document.getElementById('homeScreen').classList.remove('hidden'); 
document.getElementById('chatScreen').classList.add('hidden'); 
if(pollInterval){clearInterval(pollInterval); pollInterval=null;}
}

async function sendMessage(){
const msg=document.getElementById('messageInput').value.trim(); 
if(!msg||!currentRoom)return;
await fetch(`${SERVER_URL}/room/${currentRoom}/message`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,message:msg})});
document.getElementById('messageInput').value='';
}

function updateMemberCount(count){
document.getElementById('memberCount').textContent = count + (count==1 ? " gamer online" : " gamers online");
}

function getEmojiForUser(name){
    if(!emojiMap[name]){
        emojiMap[name] = EMOJIS[Math.floor(Math.random()*EMOJIS.length)];
    }
    return emojiMap[name];
}

function startPolling(){
pollInterval=setInterval(async()=>{
if(!currentRoom)return;
// Fetch messages
let res=await fetch(`${SERVER_URL}/room/${currentRoom}/messages`);
let data=await res.json();
let container=document.getElementById('messagesContainer'); container.innerHTML='';
if(data.messages.length===0){
    container.innerHTML='<div class="text-center text-gray-500 py-12"><i class="fas fa-comments text-4xl mb-3"></i><p>Welcome!</p></div>';
} else {
    data.messages.forEach(msg=>{
        let div=document.createElement('div'); 
        if(msg.username==='System'){
            div.className='text-center text-gray-400 italic';
            div.innerHTML=`<div class="inline-block px-3 py-1 rounded bg-gray-800">${msg.message}</div>`;
        }else{
            const emoji = getEmojiForUser(msg.username);
            div.className='flex '+(msg.username===username?'justify-end':'justify-start');
            div.innerHTML=`<div class="flex items-center space-x-2 px-3 py-1 rounded ${msg.username===username?'bg-orange-500':'bg-gray-700'}">
                <span class="text-xl">${emoji}</span>
                <span class="font-bold">${msg.username}:</span>
                <span>${msg.message}</span>
            </div>`;
        }
        container.appendChild(div);
    });
    container.scrollTop=container.scrollHeight;
}
// Fetch member count
let memRes = await fetch(`${SERVER_URL}/room/${currentRoom}/members`);
let memData = await memRes.json();
if(memData.success) updateMemberCount(memData.member_count);
},2000);}
