<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameZone Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .fade-in { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .pulse-glow { animation: pulseGlow 2s infinite; }
        @keyframes pulseGlow { 
            0%, 100% { box-shadow: 0 0 5px #f97316; }
            50% { box-shadow: 0 0 20px #f97316, 0 0 30px #f97316; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Home Screen -->
        <div id="homeScreen" class="max-w-md mx-auto fade-in">
            <div class="text-center mb-8">
                <div class="w-24 h-24 bg-gradient-to-r from-orange-500 to-red-500 rounded-full mx-auto mb-6 flex items-center justify-center pulse-glow">
                    <i class="fas fa-gamepad text-3xl"></i>
                </div>
                <h1 class="text-4xl font-bold bg-gradient-to-r from-orange-500 to-red-500 bg-clip-text text-transparent">
                    GameZone
                </h1>
                <p class="text-gray-400 mt-2">Real-time Gaming Chat</p>
            </div>

            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-orange-500 mb-2">
                            <i class="fas fa-user mr-2"></i>Your Gaming Name
                        </label>
                        <input type="text" id="usernameInput" 
                               class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-orange-500 transition-colors"
                               placeholder="Enter your name" value="Player">
                    </div>
                    
                    <button id="createRoomBtn" 
                            class="w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-bold py-4 px-6 rounded-lg transition-all duration-200 transform hover:scale-105">
                        <i class="fas fa-plus mr-2"></i>Create Gaming Room
                    </button>
                    
                    <div class="relative my-6">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-600"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="px-3 bg-gray-800 text-gray-400">or join existing room</span>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-orange-500 mb-2">
                                <i class="fas fa-key mr-2"></i>Room Code
                            </label>
                            <input type="text" id="roomIdInput" 
                                   class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-orange-500 transition-colors"
                                   placeholder="Enter room code">
                        </div>
                        <button id="joinRoomBtn" 
                                class="w-full bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white font-bold py-4 px-6 rounded-lg transition-all duration-200 transform hover:scale-105">
                            <i class="fas fa-sign-in-alt mr-2"></i>Join Room
                        </button>
                    </div>
                </div>
            </div>

            <!-- Server Status -->
            <div id="serverStatus" class="mt-6 text-center">
                <div class="inline-flex items-center px-4 py-2 rounded-full bg-gray-800 border border-gray-700">
                    <div id="statusDot" class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                    <span id="statusText" class="text-sm text-gray-400">Ready to connect</span>
                </div>
            </div>
        </div>

        <!-- Chat Screen -->
        <div id="chatScreen" class="hidden max-w-2xl mx-auto">
            <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
                <!-- Room Header -->
                <div class="bg-gradient-to-r from-orange-500 to-red-500 px-6 py-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-xl font-bold">
                                <i class="fas fa-users mr-2"></i>
                                Room: <span id="roomIdDisplay" class="font-mono">---</span>
                            </h2>
                            <p class="text-orange-100 text-sm" id="memberCount">1 gamer online</p>
                        </div>
                        <button id="leaveRoomBtn" 
                                class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            <i class="fas fa-sign-out-alt mr-2"></i>Leave
                        </button>
                    </div>
                </div>

                <!-- Messages Area -->
                <div id="messagesContainer" class="h-96 overflow-y-auto p-4 bg-gray-900/50 space-y-3">
                    <div class="text-center text-gray-500 py-12">
                        <i class="fas fa-comments text-4xl mb-3"></i>
                        <p class="text-lg">Welcome to the chat!</p>
                        <p class="text-sm mt-1">Start chatting with your gaming team</p>
                    </div>
                </div>

                <!-- Message Input -->
                <div class="border-t border-gray-700 p-4 bg-gray-800">
                    <div class="flex space-x-3">
                        <input type="text" id="messageInput" 
                               class="flex-1 px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-orange-500 transition-colors"
                               placeholder="Type your message...">
                        <button id="sendMessageBtn" 
                                class="bg-orange-500 hover:bg-orange-600 px-6 py-3 rounded-lg font-medium transition-colors flex items-center">
                            <i class="fas fa-paper-plane mr-2"></i>Send
                        </button>
                    </div>
                </div>
            </div>

            <!-- Invite Section -->
            <div class="mt-6 bg-gray-800 rounded-xl border border-gray-700 p-6">
                <h3 class="font-bold text-orange-500 mb-4">
                    <i class="fas fa-share-alt mr-2"></i> Invite Friends
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Invite Link</label>
                        <div class="flex space-x-2">
                            <input type="text" id="inviteLink" readonly
                                   class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded text-sm font-mono">
                            <button id="copyInviteBtn" 
                                    class="bg-orange-500 hover:bg-orange-600 px-4 py-2 rounded text-sm transition-colors whitespace-nowrap">
                                <i class="fas fa-copy mr-1"></i>Copy
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Room Code</label>
                        <div class="flex justify-between items-center p-3 bg-gray-700 rounded border border-gray-600">
                            <code class="text-xl font-mono font-bold text-white" id="roomCodeDisplay">---</code>
                            <button id="copyCodeBtn" class="text-orange-500 hover:text-orange-400">
                                <i class="fas fa-copy text-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 bg-gray-800 border border-green-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50">
        <div class="flex items-center space-x-3">
            <i class="fas fa-check-circle text-green-400"></i>
            <span id="toastMessage">Success!</span>
        </div>
    </div>

    <script>
        const SERVER_URL = 'gunicorn server:app';
        let currentRoom = null;
        let username = 'Player';
        let pollInterval = null;

        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            checkServerStatus();
        });

        function setupEventListeners() {
            document.getElementById('createRoomBtn').addEventListener('click', createRoom);
            document.getElementById('joinRoomBtn').addEventListener('click', joinRoom);
            document.getElementById('leaveRoomBtn').addEventListener('click', leaveRoom);
            document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
            document.getElementById('copyInviteBtn').addEventListener('click', copyInviteLink);
            document.getElementById('copyCodeBtn').addEventListener('click', copyRoomCode);
            
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
        }

        async function checkServerStatus() {
            try {
                const response = await fetch(SERVER_URL + '/health');
                const data = await response.json();
                updateServerStatus('connected', 'Server connected ✅');
            } catch (error) {
                updateServerStatus('error', 'Server offline ❌');
                showToast('Server not running. Make sure server.py is running.', 'error');
            }
        }

        function updateServerStatus(status, message) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            dot.className = `w-3 h-3 ${status === 'connected' ? 'bg-green-500' : 'bg-red-500'} rounded-full mr-2`;
            text.textContent = message;
        }

        async function createRoom() {
            try {
                username = document.getElementById('usernameInput').value.trim() || 'Player';
                if (!username) {
                    showToast('Please enter your gaming name', 'error');
                    return;
                }

                showToast('Creating gaming room...', 'info');

                const response = await fetch(SERVER_URL + '/create_invite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Room created successfully! 🎮', 'success');
                    joinRoomById(data.roomId);
                } else {
                    throw new Error(data.error || 'Failed to create room');
                }

            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        }

        async function joinRoom() {
            const roomId = document.getElementById('roomIdInput').value.trim().toUpperCase();
            if (!roomId) {
                showToast('Please enter a room code', 'error');
                return;
            }
            await joinRoomById(roomId);
        }

        async function joinRoomById(roomId) {
            try {
                username = document.getElementById('usernameInput').value.trim() || 'Player';
                
                const response = await fetch(SERVER_URL + `/room/${roomId}/join`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });

                const data = await response.json();

                if (data.success) {
                    currentRoom = roomId;
                    showChatScreen(roomId);
                    showToast(`Joined room ${roomId} successfully!`, 'success');
                    startPolling();
                } else {
                    throw new Error(data.error || 'Failed to join room');
                }

            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        }

        function showChatScreen(roomId) {
            document.getElementById('homeScreen').classList.add('hidden');
            document.getElementById('chatScreen').classList.remove('hidden');
            
            document.getElementById('roomIdDisplay').textContent = roomId;
            document.getElementById('roomCodeDisplay').textContent = roomId;
            
            const inviteUrl = `${window.location.origin}?room=${roomId}`;
            document.getElementById('inviteLink').value = inviteUrl;

            loadMessages();
            loadMembers();
        }

        function leaveRoom() {
            currentRoom = null;
            document.getElementById('homeScreen').classList.remove('hidden');
            document.getElementById('chatScreen').classList.add('hidden');
            
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
            
            showToast('Left the room', 'info');
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !currentRoom) return;

            try {
                const response = await fetch(SERVER_URL + `/room/${currentRoom}/message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, message })
                });

                const data = await response.json();

                if (data.success) {
                    addMessage(username, message, true);
                    messageInput.value = '';
                } else {
                    throw new Error(data.error || 'Failed to send message');
                }

            } catch (error) {
                showToast('Error sending message: ' + error.message, 'error');
            }
        }

        async function loadMessages() {
            if (!currentRoom) return;

            try {
                const response = await fetch(SERVER_URL + `/room/${currentRoom}/messages`);
                const data = await response.json();

                if (data.success) {
                    const messagesContainer = document.getElementById('messagesContainer');
                    messagesContainer.innerHTML = '';

                    data.messages.forEach(msg => {
                        if (msg.type === 'system') {
                            addSystemMessage(msg.message);
                        } else {
                            addMessage(msg.username, msg.message, msg.username === username);
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        async function loadMembers() {
            if (!currentRoom) return;

            try {
                const response = await fetch(SERVER_URL + `/room/${currentRoom}/members`);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('memberCount').textContent = `${data.member_count} gamers online`;
                }
            } catch (error) {
                console.error('Error loading members:', error);
            }
        }

        function startPolling() {
            // Poll for new messages every 2 seconds
            pollInterval = setInterval(() => {
                loadMessages();
                loadMembers();
            }, 2000);
        }

        function addMessage(sender, message, isOwn) {
            const messagesContainer = document.getElementById('messagesContainer');
            
            if (messagesContainer.children.length === 1 && 
                messagesContainer.children[0].classList.contains('text-center')) {
                messagesContainer.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isOwn ? 'justify-end' : 'justify-start'}`;
            messageDiv.innerHTML = `
                <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${
                    isOwn 
                    ? 'bg-gradient-to-r from-orange-500 to-red-500 text-white' 
                    : 'bg-gray-700 text-white'
                }">
                    <div class="font-medium text-xs opacity-80 ${isOwn ? 'text-orange-100' : 'text-gray-300'}">
                        ${isOwn ? 'You' : sender}
                    </div>
                    <div class="mt-1">${message}</div>
                    <div class="text-xs opacity-60 text-right mt-1">${new Date().toLocaleTimeString()}</div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addSystemMessage(message) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'text-center text-gray-500 text-sm py-2 italic';
            messageDiv.textContent = message;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function copyInviteLink() {
            const inviteLink = document.getElementById('inviteLink');
            inviteLink.select();
            document.execCommand('copy');
            showToast('Invite link copied!', 'success');
        }

        function copyRoomCode() {
            const roomCode = document.getElementById('roomCodeDisplay').textContent;
            navigator.clipboard.writeText(roomCode);
            showToast('Room code copied!', 'success');
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            const borderColor = type === 'success' ? 'border-green-500' : 
                              type === 'error' ? 'border-red-500' : 'border-blue-500';
            
            toast.className = `fixed top-4 right-4 bg-gray-800 ${borderColor} text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 z-50`;
            toastMessage.textContent = message;
            
            setTimeout(() => toast.classList.remove('translate-x-full'), 100);
            setTimeout(() => toast.classList.add('translate-x-full'), 3000);
        }
    </script>
</body>

</html>
